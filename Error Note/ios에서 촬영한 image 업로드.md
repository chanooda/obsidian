## 환경
### 서비스 
next.js 14.2.3
### 어드민 
next.js 14.0.4

## 문제 
아이폰에서 찍은 사진을 업로드 할 때 사진의 방향이 제멋대로 바뀌어서 업로드되는 문제가 있었다. 그 오류를 해결하는 과정에서 흥미로운 점을 발견했다.

### 이미지를 관리하는 로직은 이러했다. 
1. 프론트에서 파일을 올리면 해당 파일의 원본은 서버에 저장된다.
2. 업로드된 이미지를 웹 사이트용 webp로 변환하여 생성
3. 특정 사용자에게 줄 크롭, 편집한 이미지 생성

### 이 이미지들을 활용하는 과정에서 문제가 발생했다. 
1. 2번 이미지는 웹사이트에서 사용자에게 보여주는 이미지였는데 특정 이미지가 시계 반대방향으로 90도 회전되어 보임
2. 2번 이미지가 서비스 개발 서버(production), 어드민 개발 서버(production)에서는 돌아가서 보임
3. 3번 이미지는 정방향으로 잘 보임

## 원인 및 해결
복합적인 원인이 있었다. ios 환경에서 촬영된 이미지 중 특정 이미지가 회전되어서 업로드 되는 버그가 있었다. 해당 이미지가 업로드되면, 서버에는 메타데이터에 -90도로 회전되었다는 정보와 함께 저장된다. (원본 사진은 돌아감) 
mac에서 뷰어로 원본 이미지를 보니 정방향으로 바뀌어 나오는 것을 확인했다. 이 것을 바탕으로 메타데이터가 있으면 해당 메타 데이터를 기반으로 정방향으로 돌려줄 수 있고, 3번 이미지를 만드는 과정에서 sharp를 사용하는데 이 과정에서 메타데이터를 기반으로 이미지를 정방향으로 돌려주는 것 같다는 예상을 했다.

그렇게 서버에서 원본 이미지를 webp로 변환하는 로직과 크롭, 편집하는 과정을 비교해보니, 크롭 편집하는 과정에서는 `withMetadata` 를 사용하고 있었고, webp 변환 과정에서는 사용하고 있지 않았다. 결론적으로 webp로 변환하는 과정에서 `withMetadata` 를 추가하기로 했다.

추가하니, 사진이 정방향으로 잘 보이는 것을 확인했다. 

## 추가 문제 및 해결
서비스에서는 이미지가 정방향으로 잘 보이는데, 어드민에서만 이미지가 돌아가서 보이는 것을 확인했다.

서비스 개발 서버에는 next.js에서 제공하는 Image 컴포넌트를 사용했기에, next.js에서 자체적으로 sharp를 이용해서 이미지를 정방향으로 돌려줘서, 원본은 회전 되었지만 next에서 변환된 이미지는 정방향으로 잘 보이게 된다.

어드민 개발 서버에서는 antd에서 제공하는 Image 컴포넌트를 사용하고 있었기에 서버에서 내려준 사진을 그대로 사용하면서 원래대로 방향이 돌아간 채 나온다.

최종적으로, 서버에서 webp로 이미지를 변환하는 과정에서 `withMetadata` 를 사용하는 것이 아니라, `rotate` 를 통해 자체적으로 이미지를 정방향으로 회전시켜 변환하는 것으로 해결했다. 
메타 데이터를 유지시켜 해당 이미지를 사용하는 곳에서 정방향으로 바꾸는 것보다, 사진 자체를 정방향으로 돌리는 것이 다양한 환경에서 사용하기 좋을 것 같았다.
